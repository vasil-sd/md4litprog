#!/bin/bash

execdir=$(dirname $(readlink -f $0))

nopdf=$(echo "$@" | grep -F "nopdf")
nohtml=$(echo "$@" | grep -F "nohtm")
nosrc=$(echo "$@" | grep -F "nosrc")
embedfonts=$(echo "$@" | grep -F "embedfonts")

name=${1%.*}

tempname=$(mktemp -u)
tempps=${tempname}.ps
temppdf=${tempname}.pdf
theme=${execdir}/styles/light.theme
texstyle=${execdir}/styles/default.sty
plugin=${execdir}/plugin/plugin.lua
namepdf=${name}.pdf
namehtml=${name}.html

mainfont="Source Sans Pro"

export CODE_FONT="DejaVu Sans Mono"
export TEXT_FONT="Source Sans Pro"

export PLANTUML=${execdir}/plantuml/plantuml.jar
export PLANTUML_FONT="${mainfont}"
export CLASSPATH=$(dirname $(find /usr/share/java/tla-toolbox/ -type d -name tla2tex))

echo Processing:
echo "1. Generating docs:" 

if [ -z "$nopdf" ]; then
  echo '                   ' $1 '->' ${namepdf}
  pandoc -f gfm -t latex -M mainfont="${mainfont}" --highlight-style=${theme} --pdf-engine=xelatex --lua-filter=${plugin} --standalone --self-contained --include-in-header ${texstyle} -o ${temppdf} $1 > /dev/null 2>&1
  if [ -n "$embedfonts" ]; then
    pdf2ps ${temppdf} ${tempps}
    ps2pdf14 -dPDFSETTINGS=/default -dConvertImagesToIndexed=true -dLZWEncodePages=true ${tempps} ${temppdf}
  fi
  mv ${temppdf} ${namepdf}
fi

if [ -z "$nohtml" ]; then
  echo '                   ' $1 '->' ${namehtml}
  pandoc -f gfm -t html --highlight-style=${theme} --self-contained  --lua-filter=${plugin} -o ${namehtml} $1 > /dev/null 2>&1
  rm ${tempps} ${temptheme} >/dev/null 2>&1
fi

if [ -z "$nosrc" ]; then
  echo 2. Extracting sources:
  $execdir/md2sources $1 $4
fi